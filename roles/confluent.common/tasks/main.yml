---
- name: Confirm Hash Merging Enabled
  assert:
    that: lookup('config', 'DEFAULT_HASH_BEHAVIOUR') == 'merge'
    fail_msg: "Hash Merging must be enabled in ansible.cfg: Confirm current directory is cp-ansible and permissions are set to 755 not 777"
    quiet: true

# JVM Installation and Repo Setup
- include_tasks: redhat.yml
  when: ansible_os_family == "RedHat"

- include_tasks: ubuntu.yml
  when: ansible_distribution == "Ubuntu"

- include_tasks: debian.yml
  when: ansible_distribution == "Debian"

- name: Disable Require TTY in Sudoers (required for ansible synchronize)
  lineinfile:
    path: /etc/sudoers
    state: absent
    regexp: '^Defaults\s+requiretty.*$'
  tags:
    - sudo

## Enclave stuff: Begin
- name: Create Confluent Platform install directory
  file:
    path: /opt/confluent
    state: directory
    mode: 0755

- name: Test for local Confluent Platform archive
  stat:
    path: "{{ confluent_archive_path }}"
  register: local_confluent_archive

- name: Copy local Confluent Platform archive to /tmp
  copy:
    src: "{{ confluent_archive_path }}"
    remote_src: yes
    dest: /tmp
  when: local_confluent_archive.stat.exists == True

- name: Download Confluent Platform archive
  get_url:
    url: "{{ confluent_common_repository_archive_url }}"
    dest: "/tmp"
  when: local_confluent_archive.stat.exists == False

- name: Expand Confluent Platform archive
  unarchive:
    src: "/tmp/confluent-{{confluent_archive_version}}-{{confluent_archive_scala_version}}.tar.gz"
    remote_src: yes
    dest: "/opt/confluent"
    mode: 0755

# What user/group should be used here?
# - name: Create Confluent Platform logs directory
#   file:
#     path: "/opt/confluent/confluent-{{confluent_archive_version}}/logs"
#     state: directory
#     mode: 777
## Enclave stuff: End

- name: Create Jolokia directory
  file:
    path: /opt/jolokia
    state: directory
    mode: 0755
  when: jolokia_enabled|bool

- name: Download Jolokia Jar
  get_url:
    url: "{{ jolokia_jar_url }}"
    dest: "{{ jolokia_jar_path }}"
    mode: 0755
  when:
    - jolokia_enabled|bool
    - not ansible_check_mode

- name: Create Prometheus install directory
  file:
    path: /opt/prometheus
    state: directory
    mode: 0755
  when: jmxexporter_enabled|bool

- name: Download Prometheus JMX Exporter Jar
  get_url:
    url: "{{ jmxexporter_jar_url }}"
    dest: "{{ jmxexporter_jar_path }}"
    mode: 0755
  when:
    - jmxexporter_enabled|bool
    - not ansible_check_mode

- name: Download Confluent CLI - Standard
  shell: "curl -L https://cnfl.io/cli | sh -s -- -b {{ confluent_cli_path | dirname }}"
  args:
    creates: "{{ confluent_cli_path }}"
  retries: 5
  when:
    - confluent_cli_download_enabled|bool
    - confluent_cli_custom_download_url is not defined

- name: Download Confluent CLI - Custom URL
  get_url:
    url: "{{ confluent_cli_custom_download_url }}"
    dest: "{{ confluent_cli_path }}"
    mode: 0755
  when:
    - confluent_cli_download_enabled|bool
    - confluent_cli_custom_download_url is defined

- set_fact:
    common_role_completed: true
